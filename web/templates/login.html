{% extends "base.html" %}
{% block title %}Login - HiveMind{% endblock %}
{% block content %}
<!-- Page Content -->
<section class="py-5">
    <div class="container px-5">
        <div class="bg-light rounded-3 py-5 px-4 px-md-5 mb-5">
            <div class="text-center mb-5">
                <div class="feature bg-primary bg-gradient text-white rounded-3 mb-3 mx-auto" style="width: 4rem; height: 4rem;">
                    <i class="fas fa-network-wired"></i>
                </div>
                <h1 class="fw-bolder" data-i18n="login_title">歡迎回來</h1>
                <p class="lead fw-normal text-muted mb-0" data-i18n="login_subtitle">登入您的 HiveMind 帳戶</p>
            </div>
            <div class="row gx-5 justify-content-center">
                <div class="col-lg-8 col-xl-6">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                        <div class="form-floating mb-3">
                            <input class="form-control" id="username" name="username" type="text" required data-i18n-placeholder="login_username_placeholder" placeholder="請輸入用戶名" />
                            <label for="username" data-i18n="login_username_label">用戶名</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="password" name="password" type="password" required data-i18n-placeholder="login_password_placeholder" placeholder="請輸入密碼" />
                            <label for="password" data-i18n="login_password_label">密碼</label>
                        </div>
                        <!-- Cloudflare Turnstile 人機驗證 -->
                        <div class="mb-3">
                            <label class="form-label" data-i18n="login_captcha_label">人機驗證</label>
                            <div class="d-flex justify-content-center">
                                <div class="cf-turnstile" data-sitekey="0x4AAAAAABkJQaM8US5k-aWw" data-theme="auto"></div>
                            </div>
                        </div>
                        <div id="error-message" class="alert alert-danger d-none"></div>
                        <div id="success-message" class="alert alert-success d-none"></div>
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" id="submitBtn" type="submit">
                                <span id="submitText" data-i18n="login_btn">登入</span>
                                <i id="loadingIcon" class="fas fa-spinner fa-spin ms-2 d-none"></i>
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-4">
                        <p class="text-muted" data-i18n="login_no_account">
                            還沒有帳戶？
                            <a href="/register" class="link-primary text-decoration-none" data-i18n="login_register_link">立即註冊</a>
                        </p>
                        <p class="text-muted">
                            <a href="/forgot-password" class="link-primary text-decoration-none" data-i18n="login_forgot_password">忘記密碼？</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script>
async function handleLogin(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingIcon = document.getElementById('loadingIcon');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    
    // 隱藏之前的消息
    errorMessage.classList.add('d-none');
    successMessage.classList.add('d-none');
    
    // 檢查是否為本機開發環境
    const isLocalDev = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1' || 
                      window.location.hostname.includes('127.0.0.1');
    
    let turnstileResponse = '';
    
    if (!isLocalDev) {
        // 生產環境才檢查人機驗證
        turnstileResponse = document.querySelector('.cf-turnstile [name="cf-turnstile-response"]')?.value;
        if (!turnstileResponse) {
            const lang = localStorage.getItem('lang') || 'zh-tw';
            errorMessage.textContent = lang === 'zh-tw' ? '請完成人機驗證' : 'Please complete human verification';
            errorMessage.classList.remove('d-none');
            return;
        }
    } else {
        // 本機開發環境使用假的token
        turnstileResponse = 'dev-bypass-token';
    }
    
    // 顯示載入狀態
    const lang = localStorage.getItem('lang') || 'zh-tw';
    submitBtn.disabled = true;
    submitText.textContent = lang === 'zh-tw' ? '登入中...' : 'Signing in...';
    loadingIcon.classList.remove('d-none');
    
    try {
        const formData = new FormData(event.target);
        const loginData = {
            username: formData.get('username'),
            password: formData.get('password'),
            'cf-turnstile-response': turnstileResponse
        };
        
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(loginData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // 登入成功
            const successMsg = lang === 'zh-tw' ? '登入成功！正在跳轉...' : 'Login successful! Redirecting...';
            successMessage.textContent = result.message || successMsg;
            successMessage.classList.remove('d-none');
            
            // 儲存 token 和用戶信息
            localStorage.setItem('access_token', result.access_token);
            localStorage.setItem('user_info', JSON.stringify(result.user));
            
            // 通知狀態已改變並立即更新UI
            document.dispatchEvent(new Event('authChanged'));
            checkAuth();
            
            // 延遲跳轉到首頁
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            // 登入失敗
            const failMsg = lang === 'zh-tw' ? '登入失敗，請檢查帳號密碼' : 'Login failed, please check your credentials';
            errorMessage.textContent = result.error || failMsg;
            errorMessage.classList.remove('d-none');
            // 重置人機驗證
            if (!isLocalDev && typeof turnstile !== 'undefined') {
                turnstile.reset();
            }
        }
    } catch (error) {
        console.error('登入錯誤:', error);
        const networkError = lang === 'zh-tw' ? '網路錯誤，請檢查您的連線' : 'Network error, please check your connection';
        errorMessage.textContent = networkError;
        errorMessage.classList.remove('d-none');
        if (!isLocalDev && typeof turnstile !== 'undefined') {
            turnstile.reset();
        }
    } finally {
        // 恢復按鈕狀態
        submitBtn.disabled = false;
        submitText.textContent = i18n[lang]['login_btn'];
        loadingIcon.classList.add('d-none');
    }
}

// 檢查是否已經登入
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    if (token) {
        // 如果已經有 token，跳轉到首頁
        window.location.href = '/';
    }
});
document.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const form = document.getElementById('loginForm');
        if (form) {
            form.dispatchEvent(new Event('submit'));
        }
    }
});
</script>
{% endblock %}
