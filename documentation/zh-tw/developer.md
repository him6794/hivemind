# HiveMind é–‹ç™¼è€…æŒ‡å—

## æ¦‚è¿°

æ­¡è¿ä¾†åˆ° HiveMind åˆ†å¸ƒå¼é‹ç®—å¹³å°çš„é–‹ç™¼è€…æŒ‡å—ï¼æœ¬æ–‡æª”å°‡å¹«åŠ©æ‚¨äº†è§£é …ç›®æ¶æ§‹ã€é–‹ç™¼ç’°å¢ƒè¨­ç½®ã€ç·¨ç¢¼è¦ç¯„å’Œè²¢ç»æµç¨‹ã€‚

## é …ç›®æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HiveMind åˆ†å¸ƒå¼é‹ç®—å¹³å°                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Master    â”‚â—„â”€â”€â–ºâ”‚ Node Pool   â”‚â—„â”€â”€â–ºâ”‚   Worker    â”‚      â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚  â”‚ â”‚Web UI   â”‚ â”‚    â”‚ â”‚Resource â”‚ â”‚    â”‚ â”‚Task     â”‚ â”‚      â”‚
â”‚  â”‚ â”‚gRPC API â”‚ â”‚    â”‚ â”‚Manager  â”‚ â”‚    â”‚ â”‚Executor â”‚ â”‚      â”‚
â”‚  â”‚ â”‚VPN Mgmt â”‚ â”‚    â”‚ â”‚Schedulerâ”‚ â”‚    â”‚ â”‚Monitor  â”‚ â”‚      â”‚
â”‚  â”‚ â”‚Rewards  â”‚ â”‚    â”‚ â”‚Rewards  â”‚ â”‚    â”‚ â”‚Reporter â”‚ â”‚      â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚     AI      â”‚    â”‚     BT      â”‚    â”‚    Web      â”‚      â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚      â”‚
â”‚  â”‚ æ¨¡å‹åˆ†å‰²     â”‚    â”‚ P2På‚³è¼¸     â”‚    â”‚ å®˜æ–¹ç¶²ç«™     â”‚      â”‚
â”‚  â”‚ æ™ºèƒ½èª¿åº¦     â”‚    â”‚ ç¨®å­ç®¡ç†     â”‚    â”‚ ç”¨æˆ¶è¨»å†Š     â”‚      â”‚
â”‚  â”‚ (é–‹ç™¼ä¸­)     â”‚    â”‚ (å·²å®Œæˆ)     â”‚    â”‚ (å·²ä¸Šç·š)     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é …ç›®çµæ§‹

```
hivemind/
â”œâ”€â”€ ğŸ“ node_pool/                   # ç¯€é»æ± æœå‹™ï¼ˆæ ¸å¿ƒçµ„ä»¶ï¼‰
â”‚   â”œâ”€â”€ node_pool_server.py         # ä¸»æœå‹™å™¨å…¥å£ï¼ˆ594è¡Œï¼‰
â”‚   â”œâ”€â”€ user_service.py             # ç”¨æˆ¶èªè­‰æœå‹™ï¼ˆ292è¡Œï¼‰
â”‚   â”œâ”€â”€ node_manager_service.py     # ç¯€é»ç®¡ç†æœå‹™ï¼ˆ1714è¡Œï¼‰
â”‚   â”œâ”€â”€ master_node_service.py      # ä¸»æ§ç¯€é»æœå‹™ï¼ˆ1714è¡Œï¼‰
â”‚   â”œâ”€â”€ database_manager.py         # è³‡æ–™åº«ç®¡ç†ï¼ˆ125è¡Œï¼‰
â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç†ï¼ˆ31è¡Œï¼‰
â”‚   â”œâ”€â”€ nodepool_pb2.py            # gRPC å”è­°å®šç¾©
â”‚   â””â”€â”€ nodepool_pb2_grpc.py       # gRPC æœå‹™å­˜æ ¹
â”‚
â”œâ”€â”€ ğŸ“ master/                      # ä¸»æ§ç¯€é»
â”‚   â”œâ”€â”€ master_node.py             # ä¸»æ§ç¯€é»ä¸»ç¨‹åºï¼ˆ1798è¡Œï¼‰
â”‚   â”œâ”€â”€ vpn.py                     # VPN ç®¡ç†åŠŸèƒ½ï¼ˆ315è¡Œï¼‰
â”‚   â”œâ”€â”€ nodepool_pb2.py           # å”è­°å®šç¾©
â”‚   â””â”€â”€ templates_master/          # Web æ¨¡æ¿
â”‚
â”œâ”€â”€ ğŸ“ worker/                      # å·¥ä½œç¯€é»
â”‚   â”œâ”€â”€ worker_node.py             # å·¥ä½œç¯€é»ä¸»ç¨‹åºï¼ˆ1798è¡Œï¼‰
â”‚   â”œâ”€â”€ nodepool_pb2.py           # å”è­°å®šç¾©
â”‚   â”œâ”€â”€ nodepool.proto            # Protocol Buffers å®šç¾©
â”‚   â””â”€â”€ static/, templates/        # Web è³‡æº
â”‚
â”œâ”€â”€ ğŸ“ taskworker/                  # ä»»å‹™å·¥ä½œåº«
â”‚   â”œâ”€â”€ worker.py                  # ä»»å‹™åŸ·è¡Œå™¨ï¼ˆ292è¡Œï¼‰
â”‚   â”œâ”€â”€ storage.py                 # å­˜å„²ç®¡ç†ï¼ˆ166è¡Œï¼‰
â”‚   â”œâ”€â”€ dns_proxy.py              # DNS ä»£ç†ï¼ˆ103è¡Œï¼‰
â”‚   â”œâ”€â”€ rpc_service.py            # RPC æœå‹™ï¼ˆ61è¡Œï¼‰
â”‚   â””â”€â”€ protos/                   # gRPC å”è­°å®šç¾©
â”‚
â”œâ”€â”€ ğŸ“ ai/                          # AI æ¨¡çµ„ï¼ˆé–‹ç™¼ä¸­ï¼‰
â”‚   â”œâ”€â”€ main.py                   # AI ä¸»ç¨‹åºï¼ˆ61è¡Œï¼‰
â”‚   â”œâ”€â”€ breakdown.py              # ä»»å‹™åˆ†å‰²ï¼ˆ47è¡Œï¼‰
â”‚   â””â”€â”€ Identification.py         # èº«ä»½è­˜åˆ¥ï¼ˆ30è¡Œï¼‰
â”‚
â”œâ”€â”€ ğŸ“ bt/                          # BT æ¨¡çµ„
â”‚   â”œâ”€â”€ tracker.py                # BitTorrent è¿½è¹¤å™¨ï¼ˆ134è¡Œï¼‰
â”‚   â”œâ”€â”€ seeder.py                 # ç¨®å­æœå‹™å™¨ï¼ˆ88è¡Œï¼‰
â”‚   â””â”€â”€ create_torrent.py         # ç¨®å­å‰µå»ºå·¥å…·ï¼ˆ47è¡Œï¼‰
â”‚
â”œâ”€â”€ ğŸ“ web/                         # Web æœå‹™
â”‚   â”œâ”€â”€ app.py                    # Flask Web æ‡‰ç”¨ï¼ˆ205è¡Œï¼‰
â”‚   â”œâ”€â”€ vpn_service.py           # VPN æœå‹™ï¼ˆ135è¡Œï¼‰
â”‚   â”œâ”€â”€ wireguard_server.py      # WireGuard æœå‹™å™¨ï¼ˆ92è¡Œï¼‰
â”‚   â””â”€â”€ static/, templates/       # Web è³‡æº
â”‚
â””â”€â”€ ğŸ“ documentation/               # çµ±ä¸€æ–‡æª”ä¸­å¿ƒ
    â”œâ”€â”€ zh-tw/                    # ç¹é«”ä¸­æ–‡æ–‡æª”
    â””â”€â”€ en/                       # è‹±æ–‡æ–‡æª”
```

### æ ¸å¿ƒçµ„ä»¶èªªæ˜

#### 1. Node Pool (ç¯€é»æ± )
- **ä½œç”¨**: ç³»çµ±æ ¸å¿ƒï¼Œè² è²¬ç¯€é»ç®¡ç†ã€ä»»å‹™èª¿åº¦ã€ç”¨æˆ¶èªè­‰
- **ä¸»è¦æ–‡ä»¶**: `node_pool_server.py` (594è¡Œ)
- **gRPC æœå‹™**: æä¾›å®Œæ•´çš„ç¯€é»ç®¡ç† API
- **æ•¸æ“šå­˜å„²**: SQLite (ç”¨æˆ¶) + Redis (ç‹€æ…‹)

#### 2. Master Node (ä¸»æ§ç¯€é»)
- **ä½œç”¨**: æä¾›ç®¡ç†ç•Œé¢ã€VPN ç®¡ç†ã€ç³»çµ±ç›£æ§
- **ä¸»è¦æ–‡ä»¶**: `master_node.py` (1798è¡Œ)
- **åŠŸèƒ½**: Web ç•Œé¢ã€VPN é…ç½®ã€ä»»å‹™ç›£æ§

#### 3. Worker Node (å·¥ä½œç¯€é»)
- **ä½œç”¨**: åŸ·è¡Œå¯¦éš›è¨ˆç®—ä»»å‹™ã€å ±å‘Šç‹€æ…‹
- **ä¸»è¦æ–‡ä»¶**: `worker_node.py` (1798è¡Œ)
- **åŠŸèƒ½**: ä»»å‹™åŸ·è¡Œã€è³‡æºç›£æ§ã€çµæœå›å‚³

#### 4. TaskWorker (ä»»å‹™åº«)
- **ä½œç”¨**: ç¨ç«‹çš„ä»»å‹™åŸ·è¡Œåº«ï¼Œå¯è¢«å…¶ä»–é …ç›®æ•´åˆ
- **ä¸»è¦æ–‡ä»¶**: `worker.py` (292è¡Œ)
- **ç‰¹é»**: è¼•é‡ç´šã€å¯æ“´å±•ã€ç¨ç«‹éƒ¨ç½²

## é–‹ç™¼ç’°å¢ƒè¨­ç½®

### 1. ç³»çµ±è¦æ±‚

- **Python**: 3.8+
- **Redis**: 6.0+
- **Git**: 2.20+
- **ä½œæ¥­ç³»çµ±**: Linux/macOS/Windows

### 2. å…‹éš†é …ç›®

```bash
git clone https://github.com/him6794/hivemind.git
cd hivemind
```

### 3. è¨­ç½®è™›æ“¬ç’°å¢ƒ

```bash
# å‰µå»ºè™›æ“¬ç’°å¢ƒ
python -m venv hivemind-env

# å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
# Linux/macOS:
source hivemind-env/bin/activate
# Windows:
hivemind-env\Scripts\activate
```

### 4. å®‰è£ä¾è³´

```bash
# å®‰è£å…¨åŸŸä¾è³´
pip install -r requirements.txt

# å®‰è£é–‹ç™¼ä¾è³´
pip install pytest pytest-cov black flake8 mypy

# å®‰è£æ¨¡çµ„ç‰¹å®šä¾è³´
pip install -r master/requirements.txt
pip install -r worker/requirements.txt
pip install -r taskworker/requirements.txt
```

### 5. è¨­ç½® Redis

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install redis-server

# macOS
brew install redis

# å•Ÿå‹• Redis
redis-server
```

### 6. é…ç½®ç’°å¢ƒè®Šæ•¸

å‰µå»º `.env` æ–‡ä»¶ï¼š

```bash
# Node Pool é…ç½®
NODEPOOL_HOST=localhost
NODEPOOL_PORT=50051
REDIS_HOST=localhost
REDIS_PORT=6379

# é–‹ç™¼æ¨¡å¼
DEBUG=true
LOG_LEVEL=DEBUG

# æ¸¬è©¦æ•¸æ“šåº«
TEST_DB_PATH=test_users.db
```

## ä»£ç¢¼çµæ§‹èªªæ˜

### gRPC å”è­°å®šç¾©

```protobuf
// nodepool.proto
service NodePoolService {
  // ç¯€é»ç®¡ç†
  rpc RegisterNode(RegisterNodeRequest) returns (RegisterNodeResponse);
  rpc UnregisterNode(UnregisterNodeRequest) returns (UnregisterNodeResponse);
  
  // ç”¨æˆ¶ç®¡ç†
  rpc RegisterUser(RegisterUserRequest) returns (RegisterUserResponse);
  rpc LoginUser(LoginUserRequest) returns (LoginUserResponse);
  
  // ä»»å‹™ç®¡ç†
  rpc SubmitTask(SubmitTaskRequest) returns (SubmitTaskResponse);
  rpc GetTaskStatus(GetTaskStatusRequest) returns (GetTaskStatusResponse);
}
```

### ä¸»è¦é¡çµæ§‹

#### Node Pool Server
```python
class NodePoolServer:
    def __init__(self):
        self.redis_client = redis.Redis()
        self.user_service = UserService()
        self.node_manager = NodeManagerService()
        
    def serve(self):
        # å•Ÿå‹• gRPC æœå‹™å™¨
        
class UserService:
    def RegisterUser(self, request, context):
        # ç”¨æˆ¶è¨»å†Šé‚è¼¯
        
class NodeManagerService:
    def RegisterNode(self, request, context):
        # ç¯€é»è¨»å†Šé‚è¼¯
```

#### Worker Node
```python
class WorkerNode:
    def __init__(self, node_id):
        self.node_id = node_id
        self.executor = TaskExecutor()
        self.monitor = ResourceMonitor()
        
    def start(self):
        # å•Ÿå‹•å·¥ä½œç¯€é»
        
class TaskExecutor:
    def execute_task(self, task_data):
        # åŸ·è¡Œä»»å‹™é‚è¼¯
```

## é–‹ç™¼å·¥ä½œæµ

### 1. åˆ†æ”¯ç­–ç•¥

```bash
main           # ç©©å®šç‰ˆæœ¬
â”œâ”€â”€ develop    # é–‹ç™¼ä¸»åˆ†æ”¯
â”œâ”€â”€ feature/*  # åŠŸèƒ½åˆ†æ”¯
â”œâ”€â”€ hotfix/*   # ç†±ä¿®å¾©åˆ†æ”¯
â””â”€â”€ release/*  # ç™¼å¸ƒåˆ†æ”¯
```

### 2. åŠŸèƒ½é–‹ç™¼æµç¨‹

```bash
# 1. å‰µå»ºåŠŸèƒ½åˆ†æ”¯
git checkout develop
git pull origin develop
git checkout -b feature/new-feature

# 2. é–‹ç™¼å’Œæ¸¬è©¦
# ... ç·¨å¯«ä»£ç¢¼ ...
python -m pytest tests/

# 3. ä»£ç¢¼æª¢æŸ¥
black .
flake8 .
mypy .

# 4. æäº¤ä»£ç¢¼
git add .
git commit -m "feat: add new feature"

# 5. æ¨é€ä¸¦å‰µå»º PR
git push origin feature/new-feature
# åœ¨ GitHub ä¸Šå‰µå»º Pull Request
```

### 3. ä»£ç¢¼è¦ç¯„

#### Python ä»£ç¢¼é¢¨æ ¼

```python
# ä½¿ç”¨ Black æ ¼å¼åŒ–
# ä½¿ç”¨ type hints
def process_task(task_data: Dict[str, Any]) -> TaskResult:
    """è™•ç†ä»»å‹™æ•¸æ“š
    
    Args:
        task_data: ä»»å‹™è¼¸å…¥æ•¸æ“š
        
    Returns:
        è™•ç†çµæœ
        
    Raises:
        TaskExecutionError: ä»»å‹™åŸ·è¡Œå¤±æ•—æ™‚æ‹‹å‡º
    """
    pass

# ä½¿ç”¨ dataclass å®šç¾©æ•¸æ“šçµæ§‹
@dataclass
class TaskConfig:
    timeout: int = 300
    max_retries: int = 3
    priority: str = "normal"
```

#### å‘½åè¦ç¯„

- **æ–‡ä»¶å**: `snake_case.py`
- **é¡å**: `PascalCase`
- **å‡½æ•¸/è®Šæ•¸**: `snake_case`
- **å¸¸æ•¸**: `UPPER_SNAKE_CASE`
- **ç§æœ‰æˆå“¡**: `_leading_underscore`

#### æ–‡æª”å­—ç¬¦ä¸²

```python
def register_node(node_info: NodeInfo) -> bool:
    """è¨»å†Šæ–°çš„å·¥ä½œç¯€é»
    
    Args:
        node_info: ç¯€é»ä¿¡æ¯ï¼ŒåŒ…å«IDã€åœ°å€ã€èƒ½åŠ›ç­‰
        
    Returns:
        è¨»å†ŠæˆåŠŸè¿”å› Trueï¼Œå¤±æ•—è¿”å› False
        
    Example:
        >>> node_info = NodeInfo(id="worker-1", host="192.168.1.100")
        >>> success = register_node(node_info)
        >>> print(success)
        True
    """
    pass
```

## æ¸¬è©¦ç­–ç•¥

### 1. æ¸¬è©¦çµæ§‹

```
tests/
â”œâ”€â”€ unit/                    # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ test_user_service.py
â”‚   â”œâ”€â”€ test_node_manager.py
â”‚   â””â”€â”€ test_task_executor.py
â”œâ”€â”€ integration/             # æ•´åˆæ¸¬è©¦
â”‚   â”œâ”€â”€ test_grpc_services.py
â”‚   â””â”€â”€ test_worker_integration.py
â”œâ”€â”€ e2e/                     # ç«¯åˆ°ç«¯æ¸¬è©¦
â”‚   â””â”€â”€ test_full_workflow.py
â””â”€â”€ fixtures/                # æ¸¬è©¦å›ºä»¶
    â”œâ”€â”€ sample_tasks.json
    â””â”€â”€ test_data.py
```

### 2. æ¸¬è©¦ç¯„ä¾‹

```python
# tests/unit/test_user_service.py
import pytest
from node_pool.user_service import UserService

class TestUserService:
    def setup_method(self):
        self.user_service = UserService(test_mode=True)
        
    def test_register_user_success(self):
        """æ¸¬è©¦ç”¨æˆ¶è¨»å†ŠæˆåŠŸ"""
        request = RegisterUserRequest(
            username="testuser",
            password="password123",
            email="test@example.com"
        )
        response = self.user_service.RegisterUser(request, None)
        assert response.success is True
        assert response.user_id is not None
        
    def test_register_duplicate_user(self):
        """æ¸¬è©¦é‡è¤‡ç”¨æˆ¶è¨»å†Šå¤±æ•—"""
        # ç¬¬ä¸€æ¬¡è¨»å†Š
        request = RegisterUserRequest(...)
        self.user_service.RegisterUser(request, None)
        
        # ç¬¬äºŒæ¬¡è¨»å†Šæ‡‰è©²å¤±æ•—
        response = self.user_service.RegisterUser(request, None)
        assert response.success is False
        assert "already exists" in response.message
```

### 3. é‹è¡Œæ¸¬è©¦

```bash
# é‹è¡Œæ‰€æœ‰æ¸¬è©¦
pytest

# é‹è¡Œç‰¹å®šæ¸¬è©¦
pytest tests/unit/test_user_service.py

# ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
pytest --cov=node_pool --cov-report=html

# é‹è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
pytest tests/e2e/ -v
```

## éƒ¨ç½²å’Œ CI/CD

### 1. GitHub Actions é…ç½®

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:6.2
        ports:
          - 6379:6379
          
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: Run tests
      run: pytest --cov=./ --cov-report=xml
      
    - name: Upload coverage
      uses: codecov/codecov-action@v3
```

### 2. Docker åŒ–éƒ¨ç½²

```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 50051

CMD ["python", "node_pool/node_pool_server.py"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  redis:
    image: redis:6.2-alpine
    ports:
      - "6379:6379"
      
  nodepool:
    build: .
    ports:
      - "50051:50051"
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
      
  worker:
    build: 
      context: .
      dockerfile: worker/Dockerfile
    depends_on:
      - nodepool
    deploy:
      replicas: 3
```

## æ“´å±•é–‹ç™¼

### 1. æ·»åŠ æ–°çš„ gRPC æœå‹™

```bash
# 1. ä¿®æ”¹ proto æ–‡ä»¶
vim nodepool.proto

# 2. ç”Ÿæˆ Python ä»£ç¢¼
python -m grpc_tools.protoc \
    --python_out=. \
    --grpc_python_out=. \
    nodepool.proto

# 3. å¯¦ç¾æœå‹™é‚è¼¯
class NewService:
    def NewMethod(self, request, context):
        # å¯¦ç¾é‚è¼¯
        pass
```

### 2. æ·»åŠ æ–°çš„ä»»å‹™é¡å‹

```python
# taskworker/tasks/new_task.py
from taskworker.worker import BaseTask

class NewTaskType(BaseTask):
    def execute(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """åŸ·è¡Œæ–°ä»»å‹™é¡å‹"""
        # å¯¦ç¾ä»»å‹™é‚è¼¯
        return {"result": "success"}
        
# è¨»å†Šä»»å‹™é¡å‹
from taskworker.registry import register_task
register_task("new_task", NewTaskType)
```

### 3. æ·»åŠ æ–°çš„ Web API

```python
# web/api/new_endpoint.py
from flask import Blueprint, request, jsonify

new_api = Blueprint('new_api', __name__)

@new_api.route('/api/new-endpoint', methods=['POST'])
def handle_new_request():
    data = request.get_json()
    # è™•ç†é‚è¼¯
    return jsonify({"status": "success"})
```

## æ€§èƒ½å„ªåŒ–

### 1. gRPC å„ªåŒ–

```python
# é€£æ¥æ± é…ç½®
channel = grpc.insecure_channel(
    'localhost:50051',
    options=[
        ('grpc.keepalive_time_ms', 30000),
        ('grpc.keepalive_timeout_ms', 5000),
        ('grpc.http2.max_pings_without_data', 0),
        ('grpc.http2.min_ping_interval_without_data_ms', 300000),
    ]
)
```

### 2. Redis å„ªåŒ–

```python
# ä½¿ç”¨é€£æ¥æ± 
import redis.connection
pool = redis.ConnectionPool(
    host='localhost',
    port=6379,
    db=0,
    max_connections=20
)
redis_client = redis.Redis(connection_pool=pool)

# æ‰¹é‡æ“ä½œ
pipe = redis_client.pipeline()
for key, value in data.items():
    pipe.hset(key, mapping=value)
pipe.execute()
```

### 3. ç•°æ­¥è™•ç†

```python
import asyncio
import aioredis

async def async_task_handler():
    redis = aioredis.from_url("redis://localhost")
    
    async def process_task(task_data):
        # ç•°æ­¥è™•ç†ä»»å‹™
        result = await some_async_operation(task_data)
        await redis.hset("results", task_id, result)
        
    tasks = [process_task(data) for data in task_list]
    await asyncio.gather(*tasks)
```

## ç›£æ§å’Œæ—¥èªŒ

### 1. çµæ§‹åŒ–æ—¥èªŒ

```python
import structlog

logger = structlog.get_logger()

def process_task(task_id: str, user_id: str):
    logger.info(
        "Task processing started",
        task_id=task_id,
        user_id=user_id,
        module="task_processor"
    )
    
    try:
        result = execute_task()
        logger.info(
            "Task completed successfully",
            task_id=task_id,
            result_size=len(result)
        )
    except Exception as e:
        logger.error(
            "Task execution failed",
            task_id=task_id,
            error=str(e),
            exc_info=True
        )
```

### 2. æŒ‡æ¨™æ”¶é›†

```python
from prometheus_client import Counter, Histogram, Gauge

# å®šç¾©æŒ‡æ¨™
task_counter = Counter('tasks_total', 'Total number of tasks')
task_duration = Histogram('task_duration_seconds', 'Task execution time')
active_workers = Gauge('active_workers', 'Number of active workers')

# ä½¿ç”¨æŒ‡æ¨™
@task_duration.time()
def execute_task():
    task_counter.inc()
    # åŸ·è¡Œä»»å‹™
    
def update_worker_count(count):
    active_workers.set(count)
```

## å®‰å…¨è€ƒé‡

### 1. èªè­‰å’Œæˆæ¬Š

```python
import jwt
from functools import wraps

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'error': 'No token provided'}), 401
            
        try:
            payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
            current_user = payload['user_id']
        except jwt.InvalidTokenError:
            return jsonify({'error': 'Invalid token'}), 401
            
        return f(current_user, *args, **kwargs)
    return decorated_function
```

### 2. è¼¸å…¥é©—è­‰

```python
from marshmallow import Schema, fields, validate

class TaskSubmissionSchema(Schema):
    task_type = fields.Str(required=True, validate=validate.Length(min=1, max=50))
    task_data = fields.Raw(required=True)
    priority = fields.Str(validate=validate.OneOf(['low', 'normal', 'high']))

def submit_task():
    schema = TaskSubmissionSchema()
    try:
        result = schema.load(request.json)
    except ValidationError as err:
        return jsonify({'errors': err.messages}), 400
```

## è²¢ç»æŒ‡å—

### 1. æäº¤ Issue

ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿å ±å‘Š Bugï¼š

```markdown
## Bug æè¿°
ç°¡æ½”æè¿°é‡åˆ°çš„å•é¡Œ

## é‡ç¾æ­¥é©Ÿ
1. åŸ·è¡Œ `command`
2. è§€å¯Ÿçµæœ

## é æœŸè¡Œç‚º
æè¿°æ‚¨æœŸæœ›çš„æ­£ç¢ºè¡Œç‚º

## å¯¦éš›è¡Œç‚º
æè¿°å¯¦éš›ç™¼ç”Ÿçš„æƒ…æ³

## ç’°å¢ƒä¿¡æ¯
- OS: Ubuntu 20.04
- Python: 3.9.5
- HiveMind ç‰ˆæœ¬: v1.0.0
```

### 2. æäº¤ Pull Request

```markdown
## è®Šæ›´æè¿°
æè¿°æ­¤ PR çš„ç›®çš„å’Œè®Šæ›´å…§å®¹

## è®Šæ›´é¡å‹
- [ ] Bug ä¿®å¾©
- [ ] æ–°åŠŸèƒ½
- [ ] æ–‡æª”æ›´æ–°
- [ ] æ€§èƒ½å„ªåŒ–

## æ¸¬è©¦æ¸…å–®
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ•´åˆæ¸¬è©¦é€šé
- [ ] ä»£ç¢¼è¦†è“‹ç‡ > 80%
- [ ] æ–‡æª”å·²æ›´æ–°

## ç›¸é—œ Issue
Closes #123
```

### 3. ä»£ç¢¼å¯©æŸ¥æ¸…å–®

**åŠŸèƒ½æ€§**ï¼š
- [ ] ä»£ç¢¼å¯¦ç¾äº†é æœŸåŠŸèƒ½
- [ ] é‚Šç•Œæ¢ä»¶è™•ç†æ­£ç¢º
- [ ] éŒ¯èª¤è™•ç†å®Œå–„

**ä»£ç¢¼è³ªé‡**ï¼š
- [ ] ä»£ç¢¼é¢¨æ ¼ç¬¦åˆè¦ç¯„
- [ ] è®Šæ•¸å‘½åæ¸…æ™°
- [ ] å‡½æ•¸è·è²¬å–®ä¸€

**æ€§èƒ½**ï¼š
- [ ] ç„¡æ˜é¡¯æ€§èƒ½å•é¡Œ
- [ ] è³‡æºä½¿ç”¨åˆç†
- [ ] ç„¡è¨˜æ†¶é«”æ´©æ¼

**å®‰å…¨æ€§**ï¼š
- [ ] è¼¸å…¥é©—è­‰å……åˆ†
- [ ] ç„¡ SQL æ³¨å…¥é¢¨éšª
- [ ] æ•æ„Ÿä¿¡æ¯å¦¥å–„è™•ç†

## å¸¸è¦‹å•é¡Œ

### Q: å¦‚ä½•èª¿è©¦ gRPC æœå‹™ï¼Ÿ

```python
# å•Ÿç”¨ gRPC èª¿è©¦æ—¥èªŒ
import os
os.environ['GRPC_VERBOSITY'] = 'DEBUG'
os.environ['GRPC_TRACE'] = 'all'

# ä½¿ç”¨ grpcurl æ¸¬è©¦
grpcurl -plaintext localhost:50051 list
grpcurl -plaintext localhost:50051 describe NodePoolService
```

### Q: å¦‚ä½•æ¨¡æ“¬åˆ†å¸ƒå¼ç’°å¢ƒæ¸¬è©¦ï¼Ÿ

```bash
# ä½¿ç”¨ Docker Compose å‰µå»ºå¤šç¯€é»ç’°å¢ƒ
docker-compose up --scale worker=5

# æˆ–ä½¿ç”¨ Kind å‰µå»º Kubernetes æ¸¬è©¦ç’°å¢ƒ
kind create cluster
kubectl apply -f k8s/
```

### Q: å¦‚ä½•é€²è¡Œæ€§èƒ½æ¸¬è©¦ï¼Ÿ

```python
# ä½¿ç”¨ locust é€²è¡Œè² è¼‰æ¸¬è©¦
from locust import User, task, between
import grpc

class HiveMindUser(User):
    wait_time = between(1, 3)
    
    def on_start(self):
        self.channel = grpc.insecure_channel('localhost:50051')
        self.stub = nodepool_pb2_grpc.NodePoolServiceStub(self.channel)
    
    @task
    def submit_task(self):
        request = nodepool_pb2.SubmitTaskRequest(...)
        response = self.stub.SubmitTask(request)
```

---

**æ›´æ–°æ—¥æœŸ**: 2024å¹´1æœˆ  
**ç‰ˆæœ¬**: v1.0  
**ç‹€æ…‹**: å®Œæ•´çš„é–‹ç™¼è€…æŒ‡å—

**å¦‚éœ€å¹«åŠ©**: è«‹åƒè€ƒé …ç›® [Wiki](https://github.com/him6794/hivemind/wiki) æˆ–åœ¨ [Discord](https://discord.gg/hivemind) ä¸­è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚
